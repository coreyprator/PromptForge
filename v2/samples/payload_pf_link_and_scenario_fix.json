{
  "files": [
    {
      "path": "v2/scripts/scenario_pf_linkify_and_scenario_fallback.ps1",
      "language": "powershell",
      "op": "write",
      "contents": "[CmdletBinding()]\nparam([string]$ProjectRoot)\nSet-StrictMode -Version Latest\n$ErrorActionPreference = 'Stop'\n\nif ($PSBoundParameters.ContainsKey('ProjectRoot') -and $ProjectRoot) { Set-Location -LiteralPath $ProjectRoot }\n\n# --- 1) Make clickable paths support spaces + UNC ---\n$utils = Join-Path (Get-Location) 'pf\\utils.py'\nif (-not (Test-Path -LiteralPath $utils)) { throw \"Not found: $utils\" }\n$src = Get-Content -LiteralPath $utils -Raw -Encoding UTF8\n$pattern     = 'PATH_RE\\s*=\\s*re\\.compile\\([^\\)]*\\)'\n$replacement = 'PATH_RE = re.compile(r\"((?:[A-Za-z]:[\\\\/]|\\\\\\\\[^\\\\s/\\\\\\\\:*?\\\"<>|]+[\\\\/]|/)[^\\\\r\\\\n]+)\")'\n$dst = [regex]::Replace($src, $pattern, $replacement)\nif ($dst -ne $src) { Set-Content -LiteralPath $utils -Encoding utf8NoBOM -Value $dst; Write-Host 'Patched PATH_RE in pf\\utils.py' } else { Write-Host 'PATH_RE already patched' }\n\n# --- 2) Allow scenarios to fall back to PF's own script folder ---\n$ui = Join-Path (Get-Location) 'pf\\ui_app.py'\nif (-not (Test-Path -LiteralPath $ui)) { throw \"Not found: $ui\" }\n$src = Get-Content -LiteralPath $ui -Raw -Encoding UTF8\n\n# insert: self.install_scripts_dir = <PF root>\\v2\\scripts\n$src = $src -replace 'self\\.tools_dir\\s+=\\s+self\\.project_root\\s*/\\s*\"v2\"\\s*/\\s*\"tools\"', \"${0}`n        self.install_scripts_dir = Path(__file__).resolve().parent.parent / \\\"v2\\\" / \\\"scripts\\\"\"\n\n# replace the _scenario_script_for one-liner with a fallback-aware version\n$src = $src -replace 'def _scenario_script_for\\(self, name: str\\) -> Path: return .+', @\"\n    def _scenario_script_for(self, name: str) -> Path:\n        p = self.scripts_dir / f\\\"scenario_{name}.ps1\\\"\n        if p.exists():\n            return p\n        # fall back to PF's own script folder so system scenarios work in any project\n        return self.install_scripts_dir / f\\\"scenario_{name}.ps1\\\"\n\"@.Trim()\n\nSet-Content -LiteralPath $ui -Encoding utf8NoBOM -Value $src\nWrite-Host 'Patched pf\\ui_app.py (scenario fallback)'\n\nWrite-Host 'Done. Restart PF (run_ui) to reload utils.py.'\n"
    }
  ]
}
